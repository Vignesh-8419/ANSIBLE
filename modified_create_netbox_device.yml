# ============================================================
# NetBox device creation with overwrite mode + cluster + site
# ============================================================
- name: Reset per-loop variables
  set_fact:
    existing_device_id: !!null
    cluster_id: !!null
    site_id: !!null

# ---------- 1. Get cluster type ----------
- name: Get cluster type
  uri:
    #url: "{{ netbox_url }}/api/virtualization/cluster-types/?slug={{ cluster_type }}"
    url: "{{ netbox_url }}/api/virtualization/cluster-types/?slug={{ cluster_type | lower | regex_replace('[^a-z0-9]+','-') }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
    validate_certs: no
  register: cluster_type_response

# ---------- 2. Create cluster type if missing ----------
- name: Create cluster type if missing
  uri:
    url: "{{ netbox_url }}/api/virtualization/cluster-types/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      name: "{{ cluster_type }}"
      #slug: "{{ cluster_type }}"
      slug: "{{ cluster_type | lower | regex_replace('[^a-z0-9]+','-') }}"
    status_code: [200, 201]
    validate_certs: no
  #when: cluster_type_response.json.results | length == 0
  when: cluster_type_response.json.count == 0

# ---------- 3. Refresh cluster type lookup ----------
- name: Refresh cluster type lookup
  uri:
    #url: "{{ netbox_url }}/api/virtualization/cluster-types/?slug={{ cluster_type }}"
    url: "{{ netbox_url }}/api/virtualization/cluster-types/?slug={{ cluster_type | lower | regex_replace('[^a-z0-9]+','-') }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
    validate_certs: no
  register: cluster_type_response

- name: Set cluster_type_id
  set_fact:
    #cluster_type_id: "{{ (cluster_type_response.json.results | first).id }}"
    cluster_type_id: "{{ cluster_type_response.json.results[0].id }}"
  when: cluster_type_response.json.results | length > 0

# ---------- 4. Get site ----------
- name: Get site
  uri:
    #url: "{{ netbox_url }}/api/dcim/sites/?name={{ item.site }}"
    url: "{{ netbox_url }}/api/dcim/sites/?slug={{ item.site | lower | regex_replace('[^a-z0-9]+','-') }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
    validate_certs: no
  register: site_response

# ---------- 5. Create site if missing ----------
- name: Create site if missing
  uri:
    url: "{{ netbox_url }}/api/dcim/sites/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      name: "{{ item.site }}"
      #slug: "{{ item.site | lower | regex_replace('[^a-z0-9]+','-') }}"
      slug: "{{ item.site | lower | regex_replace('[^a-z0-9]+','-') }}"
    status_code: [200, 201]
    validate_certs: no
  when: site_response.json.results | length == 0

# ---------- 6. Refresh site lookup ----------
- name: Refresh site lookup
  uri:
    url: "{{ netbox_url }}/api/dcim/sites/?name={{ item.site }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
    validate_certs: no
  register: site_response

- name: Set site_id
  set_fact:
    site_id: "{{ (site_response.json.results | first).id }}"
  when: site_response.json.results | length > 0

# ---------- 7. Check if cluster exists ----------
- name: Check if cluster exists
  uri:
    #url: "{{ netbox_url }}/api/virtualization/clusters/?name={{ item.cluster }}"
    #url: "{{ netbox_url }}/api/virtualization/clusters/?slug={{ item.cluster | lower | regex_replace('[^a-z0-9]+','-') }}"
    #url: "{{ netbox_url }}/api/virtualization/clusters/?slug={{ cluster_name | lower | regex_replace('[^a-z0-9]+','-') }}"
    url: "{{ netbox_url }}/api/virtualization/clusters/?slug={{ item.cluster | lower | regex_replace('[^a-z0-9]+','-') }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
    validate_certs: no
  register: cluster_check

# ---------- 8. Create cluster only if missing ----------
- name: Create cluster (only if missing)
  uri:
    url: "{{ netbox_url }}/api/virtualization/clusters/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      name: "{{ item.cluster }}"
      # ADD THIS LINE: It ensures the slug matches your search in Task 7 and 9
      slug: "{{ item.cluster | lower | regex_replace('[^a-z0-9]+','-') }}"
      type: "{{ cluster_type_id }}"
      site: "{{ site_id }}"
    status_code: [200, 201]
    validate_certs: no
  when: cluster_check.json.count == 0  # Use .count for consistency

# ---------- 9. Refresh cluster lookup ----------
- name: Refresh cluster lookup
  uri:
    #url: "{{ netbox_url }}/api/virtualization/clusters/?name={{ item.cluster }}"
    url: "{{ netbox_url }}/api/virtualization/clusters/?slug={{ item.cluster | lower | regex_replace('[^a-z0-9]+','-') }}"
    #url: "{{ netbox_url }}/api/virtualization/clusters/?slug={{ cluster_name | lower | regex_replace('[^a-z0-9]+','-') }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
    validate_certs: no
  register: cluster_response

- name: Set cluster_id
  set_fact:
    #cluster_id: "{{ (cluster_response.json.results | first).id }}"
    cluster_id: "{{ cluster_response.json.results[0].id }}"
  #when: cluster_response.json.results | length > 0
  when: cluster_response.json.count > 0

# ---------- 10. Patch cluster site (for existing clusters) ----------
- name: Ensure cluster has correct site
  uri:
    url: "{{ netbox_url }}/api/virtualization/clusters/{{ cluster_id }}/"
    method: PATCH
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      site: "{{ site_id }}"
    status_code: [200, 201]
    validate_certs: no
  # Check if the cluster exists and if the site is either missing or wrong
  when: 
    - cluster_response.json.count > 0
    - cluster_response.json.results[0].site is none or cluster_response.json.results[0].site.id != site_id | int

# ---------- 11. Check if device already exists ----------
- name: Check if device exists
  uri:
    url: "{{ netbox_url }}/api/dcim/devices/?name={{ item.name }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
    validate_certs: no
  register: existing_device

# ---------- 12. Determine Method (POST for New, PATCH for Existing) ----------
- name: Set Device API details
  set_fact:
    device_api_url: "{{ (existing_device.json.count > 0) | ternary(netbox_url ~ '/api/dcim/devices/' ~ existing_device.json.results[0].id ~ '/', netbox_url ~ '/api/dcim/devices/') }}"
    device_api_method: "{{ (existing_device.json.count > 0) | ternary('PATCH', 'POST') }}"

# ---------- 13. Create or Update device (Preserves History) ----------
- name: Create or Update device
  uri:
    url: "{{ device_api_url }}"
    method: "{{ device_api_method }}"
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      name: "{{ item.name }}"
      device_type: "{{ device_type_id }}"
      role: "{{ role_id }}"
      site: "{{ site_id }}"
      status: "active"
      cluster: "{{ cluster_id }}"
      serial: "{{ item.serial | default('') }}"
    status_code: [200, 201]
    return_content: yes
    validate_certs: no
  register: device_response

- name: Set device_id
  set_fact:
    device_id: "{{ device_response.json.id }}"

# ---------- 14. Get or Create interface ----------
- name: Check if interface exists
  uri:
    url: "{{ netbox_url }}/api/dcim/interfaces/?device_id={{ device_id }}&name={{ item.interface }}"
    method: GET
    headers: { Authorization: "Token {{ netbox_token }}" }
    validate_certs: no  # <--- ADD THIS
  register: existing_interface

- name: Create interface if missing
  uri:
    url: "{{ netbox_url }}/api/dcim/interfaces/{{ (existing_interface.json.count > 0) | ternary(existing_interface.json.results[0].id ~ '/', '') }}"
    method: "{{ (existing_interface.json.count > 0) | ternary('PATCH', 'POST') }}"
    headers: { Authorization: "Token {{ netbox_token }}" }
    body_format: json
    body:
      device: "{{ device_id }}"
      name: "{{ item.interface }}"
      type: "1000base-t"
      mac_address: "{{ item.mac }}"
    status_code: [200, 201]
    validate_certs: no  # <--- ADD THIS
  register: interface_response

- name: Set interface_id
  set_fact:
    interface_id: "{{ interface_response.json.id if existing_interface.json.count == 0 else existing_interface.json.results[0].id }}"

# ---------- 15. Get or Create IP address ----------
- name: Check if IP exists
  uri:
    url: "{{ netbox_url }}/api/ipam/ip-addresses/?address={{ item.ip }}"
    method: GET
    headers: { Authorization: "Token {{ netbox_token }}" }
    validate_certs: no  # <--- ADD THIS
  register: existing_ip

- name: Assign IP address
  uri:
    url: "{{ netbox_url }}/api/ipam/ip-addresses/{{ (existing_ip.json.count > 0) | ternary(existing_ip.json.results[0].id ~ '/', '') }}"
    method: "{{ (existing_ip.json.count > 0) | ternary('PATCH', 'POST') }}"
    headers: { Authorization: "Token {{ netbox_token }}" }
    body_format: json
    body:
      address: "{{ item.ip }}"
      status: "active"
      assigned_object_type: "dcim.interface"
      assigned_object_id: "{{ interface_id }}"
    status_code: [200, 201]
    validate_certs: no  # <--- ADD THIS
  register: ip_response

- name: Set final IP ID for primary assignment
  set_fact:
    final_ip_id: "{{ ip_response.json.id if existing_ip.json.count == 0 else existing_ip.json.results[0].id }}"

# ---------- 16. Set primary IP ----------
- name: Set primary IP for device
  uri:
    url: "{{ netbox_url }}/api/dcim/devices/{{ device_id }}/"
    method: PATCH
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      primary_ip4: "{{ final_ip_id }}"
    status_code: [200, 201]
    validate_certs: no
