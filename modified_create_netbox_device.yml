# ============================================================
# NetBox device creation with overwrite mode + cluster + site
# ============================================================

# ---------- 1. Get cluster type ----------
- name: Get cluster type
  uri:
    url: "{{ netbox_url }}/api/virtualization/cluster-types/?slug={{ cluster_type }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
    validate_certs: no
  register: cluster_type_response

# ---------- 2. Ensure cluster type exists ----------
- name: Ensure cluster type exists
  uri:
    url: "{{ netbox_url }}/api/virtualization/cluster-types/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      name: "{{ cluster_type }}"
      slug: "{{ cluster_type }}"
    status_code: [200, 201]
    validate_certs: no
  when: cluster_type_response.json.results | length == 0

# ---------- 3. Set cluster_type_id ----------
- name: Set cluster_type_id
  set_fact:
    cluster_type_id: "{{ (cluster_type_response.json.results | first).id }}"
  when: cluster_type_response.json.results | length > 0

- name: Create cluster type if missing
  uri:
    url: "{{ netbox_url }}/api/virtualization/cluster-types/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      name: "{{ cluster_type }}"
      slug: "{{ cluster_type }}"
    status_code: [200, 201]
    validate_certs: no
  when: cluster_type_response.json.results | length == 0

- name: Fail if cluster type not found
  fail:
    msg: "Cluster type {{ cluster_type }} not found in NetBox"
  when: cluster_type_response.json.results | length == 0

# ---------- 2. Get site ID (survey-provided site name) ----------
- name: Get site ID
  uri:
    url: "{{ netbox_url }}/api/dcim/sites/?name={{ item.site }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
    validate_certs: no
  register: site_response

- name: Set site_id
  set_fact:
    site_id: "{{ (site_response.json.results | first).id }}"

# ---------- 3. Check if cluster exists ----------
- name: Check if cluster exists
  uri:
    url: "{{ netbox_url }}/api/virtualization/clusters/?name={{ item.cluster }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
    validate_certs: no
  register: cluster_check

# ---------- 4. Create cluster only if missing ----------
- name: Create cluster (only if missing)
  uri:
    url: "{{ netbox_url }}/api/virtualization/clusters/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      name: "{{ item.cluster }}"
      type: "{{ cluster_type_id }}"
      site: "{{ site_id }}"        # âœ… Now site_id is defined
    status_code: [200, 201]
    validate_certs: no
  when: cluster_check.json.results | length == 0

# ---------- 5. Get cluster ID ----------
- name: Get cluster ID
  uri:
    url: "{{ netbox_url }}/api/virtualization/clusters/?name={{ item.cluster }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
    validate_certs: no
  register: cluster_response

- name: Set cluster_id
  set_fact:
    cluster_id: "{{ (cluster_response.json.results | first).id }}"

# ---------- 6. Patch cluster site (for existing clusters) ----------
- name: Ensure cluster has correct site
  uri:
    url: "{{ netbox_url }}/api/virtualization/clusters/{{ cluster_id }}/"
    method: PATCH
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      site: "{{ site_id }}"
    status_code: [200, 201]
    validate_certs: no

# ---------- 7. Check if device already exists ----------
- name: Check if device exists
  uri:
    url: "{{ netbox_url }}/api/dcim/devices/?name={{ item.name }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
    validate_certs: no
  register: existing_device

- name: Set existing_device_id
  set_fact:
    existing_device_id: "{{ existing_device.json.results[0].id }}"
  when: existing_device.json.results | length > 0

# ---------- 8. DELETE device if exists (overwrite mode) ----------
- name: Delete existing device (overwrite mode)
  uri:
    url: "{{ netbox_url }}/api/dcim/devices/{{ existing_device_id }}/"
    method: DELETE
    headers:
      Authorization: "Token {{ netbox_token }}"
    status_code: [204, 404]
    validate_certs: no
  when: existing_device_id is defined

# ---------- 9. Create NEW device ----------
- name: Create new device
  uri:
    url: "{{ netbox_url }}/api/dcim/devices/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      name: "{{ item.name }}"
      device_type: "{{ device_type_id }}"
      role: "{{ role_id }}"
      site: "{{ site_id }}"
      status: "active"
      cluster: "{{ cluster_id }}"
      serial: "{{ item.serial | default('') }}"
    status_code: [200, 201]
    return_content: yes
    validate_certs: no
  register: device_response

- name: Set device_id
  set_fact:
    device_id: "{{ device_response.json.id }}"

# ---------- 10. Create interface ----------
- name: Create interface
  uri:
    url: "{{ netbox_url }}/api/dcim/interfaces/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      device: "{{ device_id }}"
      name: "{{ item.interface }}"
      type: "1000base-t"
      mac_address: "{{ item.mac }}"
    status_code: [200, 201]
    return_content: yes
    validate_certs: no
  register: interface_response

- name: Set interface_id
  set_fact:
    interface_id: "{{ interface_response.json.id }}"

# ---------- 11. Assign IP ----------
- name: Assign IP address
  uri:
    url: "{{ netbox_url }}/api/ipam/ip-addresses/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      address: "{{ item.ip }}"
      status: "active"
      assigned_object_type: "dcim.interface"
      assigned_object_id: "{{ interface_id }}"
    status_code: [200, 201]
    validate_certs: no
  register: ip_response

# ---------- 12. Set primary IP ----------
- name: Set primary IP for device
  uri:
    url: "{{ netbox_url }}/api/dcim/devices/{{ device_id }}/"
    method: PATCH
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      primary_ip4: "{{ ip_response.json.id }}"
    status_code: [200, 201]
    validate_certs: no
