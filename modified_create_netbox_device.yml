# ============================================================
# NetBox device creation: Safe, Idempotent, and Multi-Host Ready
# ============================================================

# ---------- 0. Reset per-loop variables ----------
- name: 0. Reset per-loop variables
  set_fact:
    cluster_type_id: !!null
    site_id: !!null
    cluster_id: !!null
    device_id: !!null
    interface_id: !!null
    final_ip_id: !!null
    existing_device_obj: {}
    existing_iface_obj: {}
    existing_ip_obj: {}

# ---------- 1. Cluster Type Logic ----------
- name: 1. Get cluster type
  uri:
    url: "{{ netbox_url }}/api/virtualization/cluster-types/?slug={{ cluster_type | lower | regex_replace('[^a-z0-9]+','-') }}"
    method: GET
    headers: { Authorization: "Token {{ netbox_token }}" }
    validate_certs: no
  register: cluster_type_response

- name: 2. Create cluster type if missing
  uri:
    url: "{{ netbox_url }}/api/virtualization/cluster-types/"
    method: POST
    headers: { Authorization: "Token {{ netbox_token }}" }
    body_format: json
    body:
      name: "{{ cluster_type }}"
      slug: "{{ cluster_type | lower | regex_replace('[^a-z0-9]+','-') }}"
    status_code: [201]
    validate_certs: no
  when: cluster_type_response.json.count == 0

- name: 3. Refresh cluster type lookup
  uri:
    url: "{{ netbox_url }}/api/virtualization/cluster-types/?slug={{ cluster_type | lower | regex_replace('[^a-z0-9]+','-') }}"
    method: GET
    headers: { Authorization: "Token {{ netbox_token }}" }
    validate_certs: no
  register: cluster_type_refresh

- name: 4. Set cluster_type_id
  set_fact:
    cluster_type_id: "{{ cluster_type_refresh.json.results[0].id }}"

# ---------- 2. Site Logic ----------
- name: 5. Get site
  uri:
    url: "{{ netbox_url }}/api/dcim/sites/?slug={{ item.site | lower | regex_replace('[^a-z0-9]+','-') }}"
    method: GET
    headers: { Authorization: "Token {{ netbox_token }}" }
    validate_certs: no
  register: site_response

- name: 6. Create site if missing
  uri:
    url: "{{ netbox_url }}/api/dcim/sites/"
    method: POST
    headers: { Authorization: "Token {{ netbox_token }}" }
    body_format: json
    body:
      name: "{{ item.site }}"
      slug: "{{ item.site | lower | regex_replace('[^a-z0-9]+','-') }}"
    status_code: [201]
    validate_certs: no
  when: site_response.json.count == 0

- name: 7. Refresh site lookup
  uri:
    url: "{{ netbox_url }}/api/dcim/sites/?slug={{ item.site | lower | regex_replace('[^a-z0-9]+','-') }}"
    method: GET
    headers: { Authorization: "Token {{ netbox_token }}" }
    validate_certs: no
  register: site_refresh

- name: 8. Set site_id
  set_fact:
    site_id: "{{ site_refresh.json.results[0].id }}"

# ---------- 3. Cluster Logic ----------
- name: 9. Check if cluster exists
  uri:
    url: "{{ netbox_url }}/api/virtualization/clusters/?slug={{ item.cluster | lower | regex_replace('[^a-z0-9]+','-') }}"
    method: GET
    headers: { Authorization: "Token {{ netbox_token }}" }
    validate_certs: no
  register: cluster_check

- name: 10. Create cluster if missing
  uri:
    url: "{{ netbox_url }}/api/virtualization/clusters/"
    method: POST
    headers: { Authorization: "Token {{ netbox_token }}" }
    body_format: json
    body:
      name: "{{ item.cluster }}"
      slug: "{{ item.cluster | lower | regex_replace('[^a-z0-9]+','-') }}"
      type: "{{ cluster_type_id }}"
      site: "{{ site_id }}"
    status_code: [201]
    validate_certs: no
  when: cluster_check.json.count == 0

- name: 11. Refresh cluster lookup
  uri:
    url: "{{ netbox_url }}/api/virtualization/clusters/?slug={{ item.cluster | lower | regex_replace('[^a-z0-9]+','-') }}"
    method: GET
    headers: { Authorization: "Token {{ netbox_token }}" }
    validate_certs: no
  register: cluster_refresh

- name: 12. Set cluster_id
  set_fact:
    cluster_id: "{{ cluster_refresh.json.results[0].id }}"

# ---------- 4. Device Logic ----------
- name: 13. Check if device exists
  uri:
    url: "{{ netbox_url }}/api/dcim/devices/?name={{ item.name }}"
    method: GET
    headers: { Authorization: "Token {{ netbox_token }}" }
    validate_certs: no
  register: existing_device

- name: 14. Set Device API details
  set_fact:
    existing_device_obj: "{{ existing_device.json.results | first | default({}) }}"
    device_exists: "{{ existing_device.json.count > 0 }}"

- name: 15. Create or Update device
  uri:
    url: "{{ (device_exists) | ternary(netbox_url ~ '/api/dcim/devices/' ~ (existing_device_obj.id | default('')) ~ '/', netbox_url ~ '/api/dcim/devices/') }}"
    method: "{{ (device_exists) | ternary('PATCH', 'POST') }}"
    headers: { Authorization: "Token {{ netbox_token }}" }
    body_format: json
    body:
      name: "{{ item.name }}"
      device_type: "{{ device_type_id }}"
      role: "{{ role_id }}"
      site: "{{ site_id }}"
      status: "active"
      cluster: "{{ cluster_id }}"
      serial: "{{ item.serial | default('') }}"
    status_code: [200, 201]
    validate_certs: no
  register: device_response

- name: 16. Set device_id
  set_fact:
    device_id: "{{ device_response.json.id | default(existing_device_obj.id) }}"

# ---------- 5. Interface Logic ----------
- name: 17. Check if interface exists
  uri:
    url: "{{ netbox_url }}/api/dcim/interfaces/?device_id={{ device_id }}&name={{ item.interface }}"
    method: GET
    headers: { Authorization: "Token {{ netbox_token }}" }
    validate_certs: no
  register: existing_interface

- name: 18. Create or Update interface
  uri:
    url: "{{ (existing_interface.json.count > 0) | ternary(netbox_url ~ '/api/dcim/interfaces/' ~ (existing_interface.json.results[0].id | default('')) ~ '/', netbox_url ~ '/api/dcim/interfaces/') }}"
    method: "{{ (existing_interface.json.count > 0) | ternary('PATCH', 'POST') }}"
    headers: { Authorization: "Token {{ netbox_token }}" }
    body_format: json
    body:
      device: "{{ device_id }}"
      name: "{{ item.interface }}"
      type: "1000base-t"
      mac_address: "{{ item.mac }}"
    status_code: [200, 201]
    validate_certs: no
  register: interface_response

- name: 19. Set interface_id
  set_fact:
    interface_id: "{{ interface_response.json.id | default(existing_interface.json.results[0].id if existing_interface.json.count > 0 else none) }}"

# ---------- 6. IP Logic ----------
- name: 20. Check if IP exists
  uri:
    url: "{{ netbox_url }}/api/ipam/ip-addresses/?address={{ item.ip }}"
    method: GET
    headers: { Authorization: "Token {{ netbox_token }}" }
    validate_certs: no
  register: existing_ip

- name: 21. Assign IP address
  uri:
    url: "{{ (existing_ip.json.count > 0) | ternary(netbox_url ~ '/api/ipam/ip-addresses/' ~ (existing_ip.json.results[0].id | default('')) ~ '/', netbox_url ~ '/api/ipam/ip-addresses/') }}"
    method: "{{ (existing_ip.json.count > 0) | ternary('PATCH', 'POST') }}"
    headers: { Authorization: "Token {{ netbox_token }}" }
    body_format: json
    body:
      address: "{{ item.ip }}"
      status: "active"
      assigned_object_type: "dcim.interface"
      assigned_object_id: "{{ interface_id }}"
    status_code: [200, 201]
    validate_certs: no
  register: ip_response

# ---------- 7. Final Association ----------
- name: 22. Set primary IP for device
  uri:
    url: "{{ netbox_url }}/api/dcim/devices/{{ device_id }}/"
    method: PATCH
    headers: { Authorization: "Token {{ netbox_token }}" }
    body_format: json
    body:
      primary_ip4: "{{ ip_response.json.id | default(existing_ip.json.results[0].id if existing_ip.json.count > 0 else none) }}"
    status_code: [200]
    validate_certs: no
  when: device_id is defined
