- name: Create tag if not exists
  uri:
    url: "{{ netbox_url }}/api/extras/tags/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      name: "{{ item.tag }}"
      slug: "{{ item.tag | lower | regex_replace('[^a-z0-9-]', '-') }}"
    status_code: [200, 201, 400]
    validate_certs: no

- name: Get tag ID
  uri:
    url: "{{ netbox_url }}/api/extras/tags/?name={{ item.tag }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
    validate_certs: no
  register: tag_response

- name: Set tag_id
  set_fact:
    tag_id: "{{ (tag_response.json.results | first).id | default(omit) }}"

- name: Create device
  uri:
    url: "{{ netbox_url }}/api/dcim/devices/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      name: "{{ item.name }}"
      device_type: "{{ device_type_id }}"
      role: "{{ role_id }}"
      site: "{{ site_id }}"
      status: "active"
      tags: "{{ tag_id | default([]) | list }}"
      serial: "{{ item.serial }}"
    status_code: [200, 201]
    return_content: yes
    validate_certs: no
  register: device_response
  when: tag_id is defined

- name: Set device_id
  set_fact:
    device_id: "{{ device_response.json.id }}"
  when: device_response is defined

- name: Create interface
  uri:
    url: "{{ netbox_url }}/api/dcim/interfaces/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      device: "{{ device_id }}"
      name: "{{ item.interface }}"
      type: "1000base-t"
      mac_address: "{{ item.mac }}"
    status_code: [200, 201]
    return_content: yes
    validate_certs: no
  register: interface_response
  when: device_id is defined

- name: Set interface_id
  set_fact:
    interface_id: "{{ interface_response.json.id }}"
  when: interface_response is defined

- name: Assign IP address
  uri:
    url: "{{ netbox_url }}/api/ipam/ip-addresses/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      address: "{{ item.ip }}"
      status: "active"
      assigned_object_type: "dcim.interface"
      assigned_object_id: "{{ interface_id }}"
    status_code: [200, 201]
    validate_certs: no
  register: ip_response
  when: interface_id is defined

- name: Set primary IP for device
  uri:
    url: "{{ netbox_url }}/api/dcim/devices/{{ device_id }}/"
    method: PATCH
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      primary_ip4: "{{ ip_response.json.id }}"
    status_code: [200, 201]
    validate_certs: no
  when: ip_response is defined and device_id is defined

- name: Set chassis serial number
  uri:
    url: "{{ netbox_url }}/api/dcim/devices/{{ device_id }}/"
    method: PATCH
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      serial: "{{ item.serial }}"
    status_code: [200, 201]
    validate_certs: no
  when: device_id is defined
