# ---------- 1. Get cluster type ----------
- name: Get cluster type
  uri:
    url: "{{ netbox_url }}/api/virtualization/cluster-types/?slug={{ cluster_type }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
    validate_certs: no
  register: cluster_type_response

# ---------- 2. Create cluster type if missing ----------
- name: Create cluster type if missing
  uri:
    url: "{{ netbox_url }}/api/virtualization/cluster-types/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      name: "{{ cluster_type }}"
      slug: "{{ cluster_type }}"
    status_code: [200, 201]
    validate_certs: no
  when: cluster_type_response.json.results | length == 0

# ---------- 3. Refresh cluster type lookup ----------
- name: Refresh cluster type lookup
  uri:
    url: "{{ netbox_url }}/api/virtualization/cluster-types/?slug={{ cluster_type }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
    validate_certs: no
  register: cluster_type_response

- name: Set cluster_type_id
  set_fact:
    cluster_type_id: "{{ (cluster_type_response.json.results | first).id }}"
  when: cluster_type_response.json.results | length > 0

# ---------- 4. Get site ----------
- name: Get site
  uri:
    url: "{{ netbox_url }}/api/dcim/sites/?name={{ item.site }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
    validate_certs: no
  register: site_response

# ---------- 5. Create site if missing ----------
- name: Create site if missing
  uri:
    url: "{{ netbox_url }}/api/dcim/sites/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
    body_format: json
    body:
      name: "{{ item.site }}"
      slug: "{{ item.site | lower | regex_replace('[^a-z0-9]+','-') }}"
    status_code: [200, 201]
    validate_certs: no
  when: site_response.json.results | length == 0

# ---------- 6. Refresh site lookup ----------
- name: Refresh site lookup
  uri:
    url: "{{ netbox_url }}/api/dcim/sites/?name={{ item.site }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    return_content: yes
    validate_certs: no
  register: site_response

- name: Set site_id
  set_fact:
    site_id: "{{ (site_response.json.results | first).id }}"
  when: site_response.json.results | length > 0
