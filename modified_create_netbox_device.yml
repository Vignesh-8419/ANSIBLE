# ============================================================
# NetBox device creation: FORCE MIGRATION LOGIC
# ============================================================

# ---------- 0. Reset per-loop variables ----------
- name: 0. Reset per-loop variables
  set_fact:
    cluster_type_id: !!null
    site_id: !!null
    cluster_id: !!null
    device_id: !!null
    interface_id: !!null
    final_ip_id: !!null
    existing_device_obj: {}

# ---------- 1. Get/Create Cluster Type ----------
- name: 1. Get cluster type
  uri:
    url: "{{ netbox_url }}/api/virtualization/cluster-types/?name={{ cluster_type }}"
    method: GET
    headers: { Authorization: "Token {{ netbox_token }}" }
    validate_certs: no
  register: cluster_type_response

- name: 2. Create cluster type if missing
  uri:
    url: "{{ netbox_url }}/api/virtualization/cluster-types/"
    method: POST
    headers: { Authorization: "Token {{ netbox_token }}" }
    body_format: json
    body:
      name: "{{ cluster_type }}"
      slug: "{{ cluster_type | lower | regex_replace('[^a-z0-9]+','-') }}"
    status_code: [201]
    validate_certs: no
  when: cluster_type_response.json.count == 0

- name: 3. Set cluster_type_id
  set_fact:
    cluster_type_id: "{{ (cluster_type_response.json.results | first).id if cluster_type_response.json.count > 0 else none }}"

# ---------- 2. Get/Create Site ----------
- name: 4. Get site
  uri:
    url: "{{ netbox_url }}/api/dcim/sites/?name={{ item.site }}"
    method: GET
    headers: { Authorization: "Token {{ netbox_token }}" }
    validate_certs: no
  register: site_response

- name: 5. Create site if missing
  uri:
    url: "{{ netbox_url }}/api/dcim/sites/"
    method: POST
    headers: { Authorization: "Token {{ netbox_token }}" }
    body_format: json
    body:
      name: "{{ item.site }}"
      slug: "{{ item.site | lower | regex_replace('[^a-z0-9]+','-') }}"
    status_code: [201]
    validate_certs: no
  when: site_response.json.count == 0

- name: 6. Set site_id
  set_fact:
    site_id: "{{ (site_response.json.results | first).id if site_response.json.count > 0 else none }}"

# ---------- 3. Get/Create Cluster (FIXED SEARCH) ----------
- name: 7. Check if cluster exists by NAME
  uri:
    url: "{{ netbox_url }}/api/virtualization/clusters/?name={{ item.cluster }}"
    method: GET
    headers: { Authorization: "Token {{ netbox_token }}" }
    validate_certs: no
  register: cluster_check

- name: 8. Create cluster if missing
  uri:
    url: "{{ netbox_url }}/api/virtualization/clusters/"
    method: POST
    headers: { Authorization: "Token {{ netbox_token }}" }
    body_format: json
    body:
      name: "{{ item.cluster }}"
      slug: "{{ item.cluster | lower | regex_replace('[^a-z0-9]+','-') }}"
      type: "{{ cluster_type_id | int }}"
      site: "{{ site_id | int }}"
    status_code: [201]
    validate_certs: no
  when: cluster_check.json.count == 0

- name: 9. Refresh Cluster ID
  uri:
    url: "{{ netbox_url }}/api/virtualization/clusters/?name={{ item.cluster }}"
    method: GET
    headers: { Authorization: "Token {{ netbox_token }}" }
    validate_certs: no
  register: cluster_refresh

- name: 10. Set cluster_id
  set_fact:
    cluster_id: "{{ cluster_refresh.json.results[0].id | int }}"

# ---------- 4. Device Update (FORCED PATCH) ----------
- name: 11. Check if device exists
  uri:
    url: "{{ netbox_url }}/api/dcim/devices/?name={{ item.name }}"
    method: GET
    headers: { Authorization: "Token {{ netbox_token }}" }
    validate_certs: no
  register: existing_device

- name: 12. Set Device Facts
  set_fact:
    device_exists: "{{ existing_device.json.count > 0 }}"
    existing_device_obj: "{{ existing_device.json.results | first | default({}) }}"

- name: 13. Create or Update device (FORCING CLUSTER CHANGE)
  uri:
    url: "{{ (device_exists) | ternary(netbox_url ~ '/api/dcim/devices/' ~ (existing_device_obj.id | default('')) ~ '/', netbox_url ~ '/api/dcim/devices/') }}"
    method: "{{ (device_exists) | ternary('PATCH', 'POST') }}"
    headers: { Authorization: "Token {{ netbox_token }}" }
    body_format: json
    body:
      name: "{{ item.name }}"
      device_type: "{{ device_type_id | int }}"
      role: "{{ role_id | int }}"
      site: "{{ site_id | int }}"
      cluster: "{{ cluster_id | int }}"
      status: "active"
    status_code: [200, 201]
    validate_certs: no
  register: device_response

- name: 14. Set device_id
  set_fact:
    device_id: "{{ device_response.json.id | default(existing_device_obj.id) | int }}"

# ---------- 5. Interface & IP Logic (REMAINDING) ----------
- name: 15. Create or Update interface
  uri:
    url: "{{ netbox_url }}/api/dcim/interfaces/"
    method: POST
    headers: { Authorization: "Token {{ netbox_token }}" }
    body_format: json
    body:
      device: "{{ device_id }}"
      name: "{{ item.interface }}"
      type: "1000base-t"
      mac_address: "{{ item.mac }}"
    status_code: [201, 400] # 400 if already exists
    validate_certs: no
  register: interface_res

- name: 16. Get Interface ID (if already exists)
  uri:
    url: "{{ netbox_url }}/api/dcim/interfaces/?device_id={{ device_id }}&name={{ item.interface }}"
    method: GET
    headers: { Authorization: "Token {{ netbox_token }}" }
    validate_certs: no
  register: iface_lookup

- name: 17. Set interface_id
  set_fact:
    interface_id: "{{ iface_lookup.json.results[0].id | int }}"

- name: 18. Assign IP address
  uri:
    url: "{{ netbox_url }}/api/ipam/ip-addresses/"
    method: POST
    headers: { Authorization: "Token {{ netbox_token }}" }
    body_format: json
    body:
      address: "{{ item.ip }}"
      status: "active"
      assigned_object_type: "dcim.interface"
      assigned_object_id: "{{ interface_id }}"
    status_code: [201, 400]
    validate_certs: no
  register: ip_res

- name: 19. Get IP ID
  uri:
    url: "{{ netbox_url }}/api/ipam/ip-addresses/?address={{ item.ip }}"
    method: GET
    headers: { Authorization: "Token {{ netbox_token }}" }
    validate_certs: no
  register: ip_lookup

- name: 20. Set primary IP for device
  uri:
    url: "{{ netbox_url }}/api/dcim/devices/{{ device_id }}/"
    method: PATCH
    headers: { Authorization: "Token {{ netbox_token }}" }
    body_format: json
    body:
      primary_ip4: "{{ ip_lookup.json.results[0].id | int }}"
    status_code: [200]
    validate_certs: no
