---
- name: Add multiple DNS entries to Pi-hole via API (skip existing)
  hosts: dns-server-01
  become: true

  vars:
    pihole_api_script_path: /root/pihole_customdns_api/pihole-customdns.sh
    netbox_url: "http://192.168.253.135"
    netbox_token: "f68492e4231a818bc477b65295c660b2409cddde"
    tag_name: "existing-centos"
    pihole_api_url: "https://pi.hole/api/config/dns/hosts"

  tasks:

    - name: Get devices tagged from NetBox
      uri:
        url: "{{ netbox_url }}/api/dcim/devices/?tag={{ tag_name }}"
        method: GET
        headers:
          Authorization: "Token {{ netbox_token }}"
        return_content: yes
      register: netbox_devices

    - name: Get IP addresses from NetBox
      uri:
        url: "{{ netbox_url }}/api/ipam/ip-addresses/"
        method: GET
        headers:
          Authorization: "Token {{ netbox_token }}"
        return_content: yes
      register: netbox_ips

    - name: Initialize dns_entries list
      set_fact:
        dns_entries: []

    - name: Build dns_entries from NetBox data
      set_fact:
        dns_entries: "{{ dns_entries + [ {
          'dns_hostname': item.name,
          'dns_ip': (
            netbox_ips.json.results
            | selectattr('assigned_object.device.name', 'equalto', item.name)
            | map(attribute='address')
            | map('regex_replace', '/.*$', '')
            | list
            | first
            | default('')
          )
        } ] }}"
      loop: "{{ netbox_devices.json.results }}"
      when: item.name is defined

    # ---------------------------
    # Get existing DNS entries
    # ---------------------------
    - name: Get existing DNS entries from Pi-hole
      shell: >
        curl -sk -X GET "{{ pihole_api_url }}" || echo '{}'
      register: existing_pihole_dns
      changed_when: false
      failed_when: false

    - name: Debug Pi-hole raw response (optional)
      debug:
        var: existing_pihole_dns.stdout

    # ---------------------------
    # Normalize Pi-hole response safely
    # ---------------------------
    - name: Normalize Pi-hole response safely
      set_fact:
        existing_dns_names: >-
          {% set parsed = (existing_pihole_dns.stdout | from_json | default({}, true)) %}
          {% if parsed is mapping and 'error' in parsed %}
          []
          {% elif parsed is mapping %}
          {{
            (parsed.get('hosts', [])
             + parsed.get('data', [])
             + ([] if not parsed else []))
            | selectattr('hostname', 'defined')
            | map(attribute='hostname')
            | list
            | unique
          }}
          {% elif parsed is iterable %}
          {{
            parsed
            | selectattr('hostname', 'defined')
            | map(attribute='hostname')
            | list
            | unique
          }}
          {% else %}
          []
          {% endif %}

    - name: Debug normalized DNS list
      debug:
        var: existing_dns_names

    # ---------------------------
    # Add only new DNS entries
    # ---------------------------
    - name: Add DNS entries using Pi-hole API script
      shell: >
        {{ pihole_api_script_path }} --add {{ item.dns_hostname }} {{ item.dns_ip }}
      args:
        chdir: "{{ pihole_api_script_path | dirname }}"
      loop: "{{ dns_entries }}"
      when:
        - item.dns_ip != ''
        - item.dns_hostname not in existing_dns_names
      register: add_results

    - name: Show final results
      debug:
        var: add_results.results
