---
- name: Add multiple DNS entries to Pi-hole via API (skip existing)
  hosts: dns-server-01
  become: false
  gather_facts: yes

  vars:
    netbox_url: "http://192.168.253.135"
    netbox_token: "f68492e4231a818bc477b65295c660b2409cddde"
    netbox_tag: "existing-centos"
    pihole_url: "http://192.168.253.151/admin/api.php"
    pihole_token: "your_pihole_api_token_here"

  tasks:

    - name: Get devices tagged from NetBox
      uri:
        url: "{{ netbox_url }}/api/dcim/devices/?tag={{ netbox_tag }}"
        method: GET
        headers:
          Authorization: "Token {{ netbox_token }}"
          Content-Type: "application/json"
        return_content: yes
      register: netbox_devices

    - name: Get IP addresses for each device from NetBox
      uri:
        url: "{{ netbox_url }}/api/ipam/ip-addresses/?device_id={{ item.id }}"
        method: GET
        headers:
          Authorization: "Token {{ netbox_token }}"
          Content-Type: "application/json"
        return_content: yes
      loop: "{{ netbox_devices.json.results }}"
      register: netbox_ips

    - name: Initialize dns_entries list
      set_fact:
        dns_entries: []

    - name: Build dns_entries from NetBox data
      set_fact:
        dns_entries: "{{ dns_entries + [ { 'hostname': item.item.name, 'ip': (item.json.results[0].address | regex_replace('/.*', '')) } ] }}"
      when: item.json.results | length > 0
      loop: "{{ netbox_ips.results }}"

    - name: Show prepared DNS entries
      debug:
        var: dns_entries

    - name: Get existing DNS entries from Pi-hole
      uri:
        url: "{{ pihole_url }}?list=local_dns&auth={{ pihole_token }}"
        method: GET
        return_content: yes
      register: existing_dns
      failed_when: existing_dns.status not in [200, 201]

    - name: Parse existing Pi-hole DNS entries
      set_fact:
        existing_dns_entries: "{{ existing_dns.json | default({}) }}"

    - name: Ensure existing_dns_entries is a list
      set_fact:
        existing_dns_entries: "{{ existing_dns_entries | dict2items if existing_dns_entries is mapping else existing_dns_entries }}"

    - name: Add DNS entries to Pi-hole (skip existing)
      uri:
        url: "{{ pihole_url }}"
        method: POST
        headers:
          Content-Type: "application/x-www-form-urlencoded"
        body_format: form-urlencoded
        body:
          auth: "{{ pihole_token }}"
          action: "add"
          ip: "{{ item.ip }}"
          domain: "{{ item.hostname }}"
        status_code: 200
      loop: "{{ dns_entries }}"
      when: item.hostname not in (existing_dns_entries | map(attribute='key') | list)
      register: added_entries

    - name: Show results
      debug:
        var: added_entries
