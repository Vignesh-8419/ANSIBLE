
1. Install cert-manager
First, the engine that handles the certificates:

Bash

kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
2. Create the ClusterIssuer (The "Passport Office")
This tells the cluster how to sign the certificates.

Bash

cat <<EOF > issuer.yaml
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: awx-selfsigned-issuer
spec:
  selfSigned: {}
EOF

kubectl apply -f issuer.yaml
3. Create the Certificate Object
This tells cert-manager to generate a specific certificate for your domain and store it in a Secret.

Bash

cat <<EOF | kubectl apply -n awx -f -
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: awx-server-cert
spec:
  secretName: awx-server-tls-secret
  duration: 2160h 
  renewBefore: 360h 
  subject:
    organizations:
      - vgs
  isCA: false
  privateKey:
    algorithm: RSA
    encoding: PKCS1
    size: 2048
  usages:
    - server auth
    - client auth
  dnsNames:
    - awx-server-01.vgs.com
  issuerRef:
    name: awx-selfsigned-issuer
    kind: ClusterIssuer
    group: cert-manager.io
EOF
4. Update the AWX Deployment (The "Merge")
This command updates the AWX Operator's configuration to enable the Ingress and point it to the secret we just created.

Bash

cat <<EOF | kubectl apply -n awx -f -
apiVersion: awx.ansible.com/v1beta1
kind: AWX
metadata:
  name: awx-prod
spec:
  service_type: NodePort
  ingress_type: ingress
  hostname: awx-server-01.vgs.com
  ingress_tls_secret: awx-server-tls-secret
  admin_password_secret: awx-admin-password
  postgres_storage_class: longhorn
  postgres_data_volume_init: true
  postgres_resource_requirements:
    requests:
      cpu: "500m"
      memory: "2Gi"
    limits:
      cpu: "2"
      memory: "4Gi"
EOF
5. The "Glue" (Connecting Ingress to Nginx)
Because the Operator sometimes leaves out the Ingress Class, we manually "pushed" it to Nginx:

Bash

kubectl patch ingress awx-prod-ingress -n awx -p '{"spec": {"ingressClassName": "nginx"}}'

How to Verify the Whole Chain
If you ever suspect a break in the "merging" of these components, run these three commands in order:

Check the Secret: kubectl get secret awx-server-tls-secret -n awx (Does it exist?)

Check the Certificate: kubectl get certificate -n awx (Is READY True?)

Check the Ingress: kubectl get ingress -n awx (Does it show the hostname and an IP address?)
