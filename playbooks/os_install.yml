- name: Provision servers via PXE
  hosts: localhost
  gather_facts: false

  vars:
    hostnames: ""
    ips: ""
    macs: ""

  tasks:
    - name: Normalize survey inputs
      set_fact:
        host_list: "{{ hostnames | replace('\"','') | trim | split(',') }}"
        ip_list: "{{ ips | replace('\"','') | trim | split(',') }}"
        mac_list: "{{ macs | replace('\"','') | trim | split(',') }}"

    - name: Validate input lengths
      assert:
        that:
          - host_list | length == ip_list | length
          - host_list | length == mac_list | length
        fail_msg: "Survey input count mismatch"

    - name: Build servers list
      set_fact:
        servers: "{{ servers | default([]) + [ {
          'hostname': item.0 | trim,
          'ip': item.1 | trim,
          'mac': item.2 | lower | trim
        } ] }}"
      loop: "{{ host_list | zip(ip_list, mac_list) | list }}"

    - name: Run PXE provisioning role
      include_role:
        name: pxe_provision
