# ============================================================
# NetBox Device Creation (Cluster-aware + Overwrite Mode)
# Fully Cleaned-Up, AWX-Safe, Idempotent
# ============================================================

# ---------- 0. Ensure Site Exists ----------
- name: Normalize site slug
  set_fact:
    site_slug: "{{ item.site_name | trim | lower | regex_replace('[^a-z0-9-]', '-') }}"

- name: Get site
  uri:
    url: "{{ netbox_url }}/api/dcim/sites/?slug={{ site_slug }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: site_lookup

- name: Create site if missing
  uri:
    url: "{{ netbox_url }}/api/dcim/sites/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ item.site_name | trim }}"
      slug: "{{ site_slug }}"
    status_code: [200, 201, 400]
    validate_certs: no
  when: site_lookup.json.results | length == 0

- name: Get final site
  uri:
    url: "{{ netbox_url }}/api/dcim/sites/?slug={{ site_slug }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: site_final

- set_fact:
    site_id: "{{ site_final.json.results[0].id }}"

# ---------- 1. Ensure Manufacturer Exists ----------
- name: Normalize manufacturer slug
  set_fact:
    manu_slug: "{{ item.manufacturer_name | trim | lower | regex_replace('[^a-z0-9-]', '-') }}"

- name: Get manufacturer
  uri:
    url: "{{ netbox_url }}/api/dcim/manufacturers/?slug={{ manu_slug }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: manu_lookup

- name: Create manufacturer if missing
  uri:
    url: "{{ netbox_url }}/api/dcim/manufacturers/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ item.manufacturer_name | trim }}"
      slug: "{{ manu_slug }}"
    status_code: [200, 201, 400]
    validate_certs: no
  when: manu_lookup.json.results | length == 0

- name: Get final manufacturer
  uri:
    url: "{{ netbox_url }}/api/dcim/manufacturers/?slug={{ manu_slug }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: manu_final

- set_fact:
    manufacturer_id: "{{ manu_final.json.results[0].id }}"

# ---------- 2. Ensure Device Type Exists ----------
- name: Normalize device type slug
  set_fact:
    dtype_slug: "{{ item.device_type_name | trim | lower | regex_replace('[^a-z0-9-]', '-') }}"

- name: Get device type
  uri:
    url: "{{ netbox_url }}/api/dcim/device-types/?slug={{ dtype_slug }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: dtype_lookup

- name: Create device type if missing
  uri:
    url: "{{ netbox_url }}/api/dcim/device-types/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      model: "{{ item.device_type_name | trim }}"
      slug: "{{ dtype_slug }}"
      manufacturer: "{{ manufacturer_id }}"
    status_code: [200, 201, 400]
    validate_certs: no
  when: dtype_lookup.json.results | length == 0

- name: Get final device type
  uri:
    url: "{{ netbox_url }}/api/dcim/device-types/?slug={{ dtype_slug }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: dtype_final

- set_fact:
    device_type_id: "{{ dtype_final.json.results[0].id }}"

# ---------- 3. Ensure Cluster Type Exists ----------
- name: Normalize cluster type slug
  set_fact:
    ctype_slug: "{{ item.cluster_type | trim | lower | regex_replace('[^a-z0-9-]', '-') }}"

- name: Get cluster type
  uri:
    url: "{{ netbox_url }}/api/virtualization/cluster-types/?slug={{ ctype_slug }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: ctype_lookup

- name: Create cluster type if missing
  uri:
    url: "{{ netbox_url }}/api/virtualization/cluster-types/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ item.cluster_type | trim }}"
      slug: "{{ ctype_slug }}"
    status_code: [200, 201, 400]
    validate_certs: no
  when: ctype_lookup.json.results | length == 0

- name: Get final cluster type
  uri:
    url: "{{ netbox_url }}/api/virtualization/cluster-types/?slug={{ ctype_slug }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: ctype_final

- set_fact:
    cluster_type_id: "{{ ctype_final.json.results[0].id }}"

# ---------- 4. Ensure Cluster Exists ----------
- name: Normalize cluster slug
  set_fact:
    cluster_slug: "{{ item.cluster_name | trim | lower | regex_replace('[^a-z0-9-]', '-') }}"

- name: Get cluster
  uri:
    url: "{{ netbox_url }}/api/virtualization/clusters/?slug={{ cluster_slug }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: cluster_lookup

- name: Create cluster if missing
  uri:
    url: "{{ netbox_url }}/api/virtualization/clusters/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ item.cluster_name | trim }}"
      slug: "{{ cluster_slug }}"
      type: "{{ cluster_type_id }}"
      site: "{{ site_id }}"
    status_code: [200, 201, 400]
    validate_certs: no
  when: cluster_lookup.json.results | length == 0

- name: Get final cluster
  uri:
    url: "{{ netbox_url }}/api/virtualization/clusters/?slug={{ cluster_slug }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: cluster_final

- set_fact:
    cluster_id: "{{ cluster_final.json.results[0].id }}"

# ---------- 5. Ensure Device Exists ----------
- name: Normalize device name
  set_fact:
    device_name_clean: "{{ item.device_name | trim }}"

- name: Check if device exists
  uri:
    url: "{{ netbox_url }}/api/dcim/devices/?name={{ device_name_clean }}&site_id={{ site_id }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: device_lookup

- name: Create device if missing
  uri:
    url: "{{ netbox_url }}/api/dcim/devices/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ device_name_clean }}"
      device_type: "{{ device_type_id }}"
      role: 1
      site: "{{ site_id }}"
      cluster: "{{ cluster_id }}"
      status: "active"
    status_code: [200, 201]
    validate_certs: no
  register: device_create
  when: device_lookup.json.results | length == 0

- name: Set device ID
  set_fact:
    device_id: >-
      {{ device_lookup.json.results[0].id
         if device_lookup.json.results | length > 0
         else device_create.json.id
      }}

# ---------- 5b. Overwrite cluster (your required logic) ----------
- name: Ensure device is in correct cluster
  uri:
    url: "{{ netbox_url }}/api/dcim/devices/{{ device_id }}/"
    method: PATCH
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      cluster: "{{ cluster_id }}"
    status_code: [200, 201]
    validate_certs: no

# ---------- 6. Ensure Interface Exists ----------
- name: Normalize interface name
  set_fact:
    iface_name_clean: "{{ item.interface_name | trim }}"

- name: Check interface
  uri:
    url: "{{ netbox_url }}/api/dcim/interfaces/?device_id={{ device_id }}&name={{ iface_name_clean }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: iface_lookup

- name: Create interface if missing
  uri:
    url: "{{ netbox_url }}/api/dcim/interfaces/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      device: "{{ device_id }}"
      name: "{{ iface_name_clean }}"
      type: "1000base-t"
      mac_address: "{{ item.mac_address | trim }}"
    status_code: [200, 201]
    validate_certs: no
  register: iface_create
  when: iface_lookup.json.results | length == 0

- name: Set interface ID
  set_fact:
    interface_id: >-
      {{ iface_lookup.json.results[0].id
         if iface_lookup.json.results | length > 0
         else iface_create.json.id
      }}

# ---------- 7. Ensure IP Exists ----------
- name: Normalize IP
  set_fact:
    ip_clean: "{{ item.ip_address | trim }}"

- name: Check IP
  uri:
    url: "{{ netbox_url }}/api/ipam/ip-addresses/?address={{ ip_clean }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: ip_lookup

- name: Create IP if missing
  uri:
    url: "{{ netbox_url }}/api/ipam/ip-addresses/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      address: "{{ ip_clean }}"
      status: "active"
      assigned_object_type: "dcim.interface"
      assigned_object_id: "{{ interface_id }}"
    status_code: [200, 201]
    validate_certs: no
  register: ip_create
  when: ip_lookup.json.results | length == 0

- name: Set IP ID
  set_fact:
    ip_id: >-
      {{ ip_lookup.json.results[0].id
         if ip_lookup.json.results | length > 0
         else ip_create.json.id
      }}

# ---------- 8. Set Primary IP ----------
- name: Set primary IP for device
  uri:
    url: "{{ netbox_url }}/api/dcim/devices/{{ device_id }}/"
    method: PATCH
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      primary_ip4: "{{ ip_id }}"
    status_code: [200, 201]
    validate_certs: no
