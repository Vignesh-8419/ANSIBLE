# ============================================================
# ✅ SITE (name-based lookup)
# ============================================================

- name: Get site
  uri:
    url: "{{ netbox_url }}/api/dcim/sites/?name={{ item.site_name | urlencode }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: site_lookup

- name: Create site if missing
  uri:
    url: "{{ netbox_url }}/api/dcim/sites/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ item.site_name }}"
      slug: "{{ item.site_name | lower | regex_replace('[^a-z0-9-]', '-') }}"
    status_code: [200, 201]
    validate_certs: no
  when: site_lookup.json.results | length == 0

- name: Get final site ID
  uri:
    url: "{{ netbox_url }}/api/dcim/sites/?name={{ item.site_name | urlencode }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: site_final

- set_fact:
    site_id: "{{ site_final.json.results[0].id }}"

# ============================================================
# ✅ MANUFACTURER
# ============================================================

- name: Get manufacturer
  uri:
    url: "{{ netbox_url }}/api/dcim/manufacturers/?name={{ item.manufacturer_name | urlencode }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: manu_lookup

- name: Create manufacturer if missing
  uri:
    url: "{{ netbox_url }}/api/dcim/manufacturers/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ item.manufacturer_name }}"
      slug: "{{ item.manufacturer_name | lower | regex_replace('[^a-z0-9-]', '-') }}"
    status_code: [200, 201]
    validate_certs: no
  when: manu_lookup.json.results | length == 0

- name: Get final manufacturer ID
  uri:
    url: "{{ netbox_url }}/api/dcim/manufacturers/?name={{ item.manufacturer_name | urlencode }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: manu_final

- set_fact:
    manufacturer_id: "{{ manu_final.json.results[0].id }}"

# ============================================================
# ✅ DEVICE TYPE
# ============================================================

- name: Get device type
  uri:
    url: "{{ netbox_url }}/api/dcim/device-types/?model={{ item.device_type_name | urlencode }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: dtype_lookup

- name: Create device type if missing
  uri:
    url: "{{ netbox_url }}/api/dcim/device-types/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      model: "{{ item.device_type_name }}"
      slug: "{{ item.device_type_name | lower | regex_replace('[^a-z0-9-]', '-') }}"
      manufacturer: "{{ manufacturer_id }}"
    status_code: [200, 201]
    validate_certs: no
  when: dtype_lookup.json.results | length == 0

- name: Get final device type ID
  uri:
    url: "{{ netbox_url }}/api/dcim/device-types/?model={{ item.device_type_name | urlencode }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: dtype_final

- set_fact:
    device_type_id: "{{ dtype_final.json.results[0].id }}"

# ============================================================
# ✅ CLUSTER TYPE
# ============================================================

- name: Get cluster type
  uri:
    url: "{{ netbox_url }}/api/virtualization/cluster-types/?name={{ item.cluster_type | urlencode }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: ctype_lookup

- name: Create cluster type if missing
  uri:
    url: "{{ netbox_url }}/api/virtualization/cluster-types/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ item.cluster_type }}"
      slug: "{{ item.cluster_type | lower | regex_replace('[^a-z0-9-]', '-') }}"
    status_code: [200, 201]
    validate_certs: no
  when: ctype_lookup.json.results | length == 0

- name: Get final cluster type ID
  uri:
    url: "{{ netbox_url }}/api/virtualization/cluster-types/?name={{ item.cluster_type | urlencode }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: ctype_final

- set_fact:
    cluster_type_id: "{{ ctype_final.json.results[0].id }}"

# ============================================================
# ✅ CLUSTER (name-based lookup)
# ============================================================

- name: Get cluster
  uri:
    url: "{{ netbox_url }}/api/virtualization/clusters/?name={{ item.cluster_name | urlencode }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: cluster_lookup

- name: Create cluster if missing
  uri:
    url: "{{ netbox_url }}/api/virtualization/clusters/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ item.cluster_name }}"
      slug: "{{ item.cluster_name | lower | regex_replace('[^a-z0-9-]', '-') }}"
      type: "{{ cluster_type_id }}"
      site: "{{ site_id }}"
    status_code: [200, 201]
    validate_certs: no
  when: cluster_lookup.json.results | length == 0

- name: Get final cluster ID
  uri:
    url: "{{ netbox_url }}/api/virtualization/clusters/?name={{ item.cluster_name | urlencode }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: cluster_final

- set_fact:
    cluster_id: "{{ cluster_final.json.results[0].id }}"

# ============================================================
# ✅ DEVICE CREATION
# ============================================================

- name: Check if device exists
  uri:
    url: "{{ netbox_url }}/api/dcim/devices/?name={{ item.device_name | urlencode }}"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
    validate_certs: no
  register: device_lookup

- name: Create device if missing
  uri:
    url: "{{ netbox_url }}/api/dcim/devices/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ item.device_name }}"
      device_type: "{{ device_type_id }}"
      role: 1
      site: "{{ site_id }}"
      cluster: "{{ cluster_id }}"
      status: "active"
    status_code: [200, 201]
    validate_certs: no
  when: device_lookup.json.results | length == 0
  register: device_create

- name: Set device ID
  set_fact:
    device_id: "{{ (device_lookup.json.results[0].id if device_lookup.json.results|length > 0 else device_create.json.id) }}"

# ============================================================
# ✅ INTERFACE
# ============================================================

- name: Create interface
  uri:
    url: "{{ netbox_url }}/api/dcim/interfaces/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      device: "{{ device_id }}"
      name: "{{ item.interface_name }}"
      type: "1000base-t"
      mac_address: "{{ item.mac_address }}"
    status_code: [200, 201]
    validate_certs: no
  register: iface_create

- set_fact:
    interface_id: "{{ iface_create.json.id }}"

# ============================================================
# ✅ IP + PRIMARY IP
# ============================================================

- name: Assign IP
  uri:
    url: "{{ netbox_url }}/api/ipam/ip-addresses/"
    method: POST
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      address: "{{ item.ip_address }}"
      status: "active"
      assigned_object_type: "dcim.interface"
      assigned_object_id: "{{ interface_id }}"
    status_code: [200, 201]
    validate_certs: no
  register: ip_create

- name: Set primary IP
  uri:
    url: "{{ netbox_url }}/api/dcim/devices/{{ device_id }}/"
    method: PATCH
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      primary_ip4: "{{ ip_create.json.id }}"
    status_code: [200, 201]
    validate_certs: no
