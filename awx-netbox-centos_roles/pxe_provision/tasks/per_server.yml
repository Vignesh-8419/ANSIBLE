---
# STEP 1: PREPARE THE NETWORK INFRASTRUCTURE
- name: Add DHCP reservation and restart service
  shell: |
    sshpass -p "{{ ansible_password }}" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@192.168.253.160 <<EOF
    sed -i '/# BEGIN ANSIBLE {{ server.hostname }}/,/# END ANSIBLE {{ server.hostname }}/d' /etc/dhcp/dhcpd.conf
    cat >> /etc/dhcp/dhcpd.conf <<DHCP_EOF
    # BEGIN ANSIBLE {{ server.hostname }}
    host {{ server.hostname }} {
      hardware ethernet {{ server.mac }};
      fixed-address {{ server.ip }};
      option host-name "{{ server.hostname }}";
      filename "grub2/grubx64.efi";
    }
    # END ANSIBLE {{ server.hostname }}
    DHCP_EOF
    systemctl restart dhcpd
    EOF
  delegate_to: localhost

- name: Generate per-host GRUB config via SSH pipe
  shell: |
    sshpass -p "{{ ansible_password }}" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@192.168.253.160 "cat > /var/lib/tftpboot/grub2/grub.cfg-01-{{ server.mac | regex_replace(':','-') | lower }}" <<EOF
    {{ lookup('template', 'grub-centos7.j2') }}
    EOF
  delegate_to: localhost

# STEP 2: CONFIGURE VM HARDWARE AND POWER ON
- name: Configure and Power On existing VM
  shell: |
    # 1. Get Authentication Token
    SESSION_ID=$(curl -k -s -X POST -u "{{ nb_ctx.vcenter_username }}:{{ nb_ctx.vcenter_password }}" https://{{ nb_ctx.vcenter_hostname }}/api/session | tr -d '"')
    if [ -z "$SESSION_ID" ] || [ "$SESSION_ID" == "null" ]; then echo "Auth Failed"; exit 1; fi

    # 2. Get the VM ID by name
    VM_ID=$(curl -k -s -H "vmware-api-session-id: $SESSION_ID" "https://{{ nb_ctx.vcenter_hostname }}/api/vcenter/vm?filter.names={{ server.hostname }}" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data['value'][0]['vm']) if data.get('value') else print('')")
    if [ -z "$VM_ID" ]; then echo "VM Not Found: {{ server.hostname }}"; exit 1; fi

    # 3. Set Firmware to EFI and Boot Order to include Network
    # Using a simpler JSON structure
    curl -k -s -X PATCH "https://{{ nb_ctx.vcenter_hostname }}/api/vcenter/vm/$VM_ID" \
      -H "vmware-api-session-id: $SESSION_ID" \
      -H "Content-Type: application/json" \
      -d '{"boot": {"type": "EFI", "network_protocol": "IPV4"}}'

    # 4. Check Power State and Start if necessary
    POWER_STATE=$(curl -k -s -H "vmware-api-session-id: $SESSION_ID" "https://{{ nb_ctx.vcenter_hostname }}/api/vcenter/vm/$VM_ID/power" | python3 -c "import sys, json; print(json.load(sys.stdin)['value']['state'])")
    
    if [ "$POWER_STATE" == "POWERED_OFF" ]; then
        curl -k -s -X POST "https://{{ nb_ctx.vcenter_hostname }}/api/vcenter/vm/$VM_ID/power?action=start" -H "vmware-api-session-id: $SESSION_ID"
    else
        # If already on, we reset it to trigger PXE
        curl -k -s -X POST "https://{{ nb_ctx.vcenter_hostname }}/api/vcenter/vm/$VM_ID/power?action=reset" -H "vmware-api-session-id: $SESSION_ID"
    fi

    # 5. Wait for PXE to pick up
    sleep 20

    # 6. Set next boot to DISK
    curl -k -s -X PATCH "https://{{ nb_ctx.vcenter_hostname }}/api/vcenter/vm/$VM_ID" \
      -H "vmware-api-session-id: $SESSION_ID" \
      -H "Content-Type: application/json" \
      -d '{"boot_devices": [{"type": "DISK"}]}'
  delegate_to: localhost

# STEP 3: MONITOR
- name: Wait for OS installation to complete (SSH check)
  wait_for:
    host: "{{ server.ip }}"
    port: 22
    state: started
    delay: 60
    timeout: 1200
  delegate_to: localhost
