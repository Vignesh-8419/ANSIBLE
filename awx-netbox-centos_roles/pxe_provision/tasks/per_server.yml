---
- name: Create and Power On VM (Bypassing Python/Requests issues)
  shell: |
    # 1. Get Authentication Token
    SESSION_ID=$(curl -k -s -X POST \
      -u "{{ nb_ctx.vcenter_username }}:{{ nb_ctx.vcenter_password }}" \
      https://{{ nb_ctx.vcenter_hostname }}/api/session | tr -d '"')

    # 2. Create the VM 
    # NOTE: I am using 'placement' without specific folder/datastore to use vCenter defaults
    # If this fails, we will need to provide the specific IDs.
    CREATE_RESP=$(curl -k -s -X POST https://{{ nb_ctx.vcenter_hostname }}/api/vcenter/vm \
      -H "vmware-api-session-id: $SESSION_ID" \
      -H "Content-Type: application/json" \
      -d '{
        "name": "{{ server.hostname }}",
        "guest_OS": "CENTOS_7_64",
        "cpu": { "count": {{ nb_ctx.default_cpus }} },
        "memory": { "size_MiB": {{ nb_ctx.default_memory_mb }} },
        "nics": [{
            "backing": { "type": "STANDARD_PORTGROUP", "network": "{{ nb_ctx.vm_network }}" },
            "allow_guest_control": true,
            "mac_address": "{{ server.mac }}",
            "mac_type": "MANUAL",
            "start_connected": true
        }],
        "disks": [{
            "new_vmdk": { "capacity": {{ nb_ctx.disk_size_gb | int * 1024 * 1024 * 1024 }} }
        }]
      }')

    # 3. Find VM ID and Power On
    # We list VMs and filter by the name we just created
    VM_ID=$(curl -k -s -H "vmware-api-session-id: $SESSION_ID" \
      "https://{{ nb_ctx.vcenter_hostname }}/api/vcenter/vm?names={{ server.hostname }}" | grep -o 'vm-[0-9]*' | head -1)
    
    curl -k -s -X POST "https://{{ nb_ctx.vcenter_hostname }}/api/vcenter/vm/$VM_ID/power?action=start" \
      -H "vmware-api-session-id: $SESSION_ID"
      
    echo "Create Response: $CREATE_RESP"
  delegate_to: localhost
  register: vm_create_debug

- name: Debug vCenter Response if failed
  debug:
    var: vm_create_debug.stdout
  when: vm_create_debug.rc != 0

# Step 2: Generate per-host GRUB config on TFTP server
- name: Generate per-host GRUB config via SSH pipe
  shell: |
    sshpass -p "{{ ansible_password }}" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@192.168.253.160 "cat > /var/lib/tftpboot/grub2/grub.cfg-01-{{ server.mac | regex_replace(':','-') | lower }}" <<EOF
    {{ lookup('template', 'grub-centos7.j2') }}
    EOF
  delegate_to: localhost

# Step 3: Add DHCP reservation and restart service
- name: Add DHCP reservation and restart service
  shell: |
    sshpass -p "{{ ansible_password }}" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@192.168.253.160 <<EOF
    sed -i '/# BEGIN ANSIBLE {{ server.hostname }}/,/# END ANSIBLE {{ server.hostname }}/d' /etc/dhcp/dhcpd.conf
    cat >> /etc/dhcp/dhcpd.conf <<DHCP_EOF
    # BEGIN ANSIBLE {{ server.hostname }}
    host {{ server.hostname }} {
      hardware ethernet {{ server.mac }};
      fixed-address {{ server.ip }};
      option host-name "{{ server.hostname }}";
      filename "grub2/grubx64.efi";
    }
    # END ANSIBLE {{ server.hostname }}
    DHCP_EOF
    systemctl restart dhcpd
    EOF
  delegate_to: localhost
