- name: Create VM if not exists
  vmware_guest:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password | default('admin$22') }}"  # or store in AWX Credential
    validate_certs: false
    datacenter: "{{ datacenter_name }}"
    name: "{{ server.hostname }}"
    state: present
    guest_id: "otherGuest64"
    boot_firmware: bios
    boot_order:
      - network
      - disk
    hardware:
      memory_mb: "{{ default_memory_mb }}"
      num_cpus: "{{ default_cpus }}"
    networks:
      - name: "{{ vm_network }}"
        device_type: vmxnet3
        mac: "{{ server.mac }}"
    disk:
      - size_gb: "{{ disk_size_gb }}"
        type: thin
        datastore: "{{ datastore }}"

- name: Generate per-host GRUB config
  template:
    src: grub-centos7.j2
    dest: "{{ pxe_folder }}/grub2/grub.cfg-01-{{ server.mac | lower | regex_replace(':','-') }}"
    mode: '0644'
  delegate_to: tftp-server-01

- name: Add DHCP reservation
  blockinfile:
    path: /etc/dhcp/dhcpd.conf
    marker: "# {mark} ANSIBLE {{ server.hostname }}"
    block: |
      host {{ server.hostname }} {
        hardware ethernet {{ server.mac }};
        fixed-address {{ server.ip }};
        option host-name "{{ server.hostname }}";
      }
  delegate_to: tftp-server-01
  notify: restart dhcpd
