---
# Step 1: Create the Virtual Machine
# We use the python interpreter override to find the 'requests' library in AWX
- name: Create and Power On VM
  community.vmware.vmware_guest:
    hostname: "{{ nb_ctx.vcenter_hostname }}"
    username: "{{ nb_ctx.vcenter_username }}"
    password: "{{ nb_ctx.vcenter_password }}"
    validate_certs: false
    datacenter: "{{ nb_ctx.datacenter_name }}"
    folder: "{{ nb_ctx.folder }}"
    name: "{{ server.hostname }}"
    state: poweredon
    guest_id: centos7_64Guest
    hardware:
      memory_mb: "{{ nb_ctx.default_memory_mb }}"
      num_cpus: "{{ nb_ctx.default_cpus }}"
    networks:
      - name: "{{ nb_ctx.vm_network }}"
        mac: "{{ server.mac }}"
    disk:
      - size_gb: "{{ nb_ctx.disk_size_gb }}"
        type: thin
        datastore: "{{ nb_ctx.datastore }}"
  delegate_to: localhost
  vars:
    ansible_python_interpreter: /usr/bin/python3

# Step 2: Generate per-host GRUB config on TFTP server
# Using the SSH pipe logic to bypass SFTP/Permissions issues
- name: Generate per-host GRUB config via SSH pipe
  shell: |
    sshpass -p "{{ ansible_password }}" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@192.168.253.160 "cat > /var/lib/tftpboot/grub2/grub.cfg-01-{{ server.mac | regex_replace(':','-') | lower }}" <<EOF
    {{ lookup('template', 'grub-centos7.j2') }}
    EOF
  delegate_to: localhost

# Step 3: Add DHCP reservation and restart DHCP service
- name: Add DHCP reservation and restart service
  shell: |
    sshpass -p "{{ ansible_password }}" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@192.168.253.160 <<EOF
    # Remove old entries to prevent duplicates
    sed -i '/# BEGIN ANSIBLE {{ server.hostname }}/,/# END ANSIBLE {{ server.hostname }}/d' /etc/dhcp/dhcpd.conf
    # Append new host configuration
    cat >> /etc/dhcp/dhcpd.conf <<DHCP_EOF
    # BEGIN ANSIBLE {{ server.hostname }}
    host {{ server.hostname }} {
      hardware ethernet {{ server.mac }};
      fixed-address {{ server.ip }};
      option host-name "{{ server.hostname }}";
      filename "grub2/grubx64.efi";
    }
    # END ANSIBLE {{ server.hostname }}
    DHCP_EOF
    # Restart the service immediately
    systemctl restart dhcpd
    EOF
  delegate_to: localhost
