---
# STEP 1: PREPARE NETWORK (DHCP & TFTP)
- name: Add DHCP reservation and restart service
  shell: |
    sshpass -p "{{ ansible_password }}" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@192.168.253.160 <<EOF
    sed -i '/# BEGIN ANSIBLE {{ server.hostname }}/,/# END ANSIBLE {{ server.hostname }}/d' /etc/dhcp/dhcpd.conf
    cat >> /etc/dhcp/dhcpd.conf <<DHCP_EOF
    # BEGIN ANSIBLE {{ server.hostname }}
    host {{ server.hostname }} {
      hardware ethernet {{ server.mac }};
      fixed-address {{ server.ip }};
      option host-name "{{ server.hostname }}";
      filename "grub2/grubx64.efi";
    }
    # END ANSIBLE {{ server.hostname }}
    DHCP_EOF
    systemctl restart dhcpd
    EOF
  delegate_to: localhost

- name: Generate per-host GRUB config
  shell: |
    sshpass -p "{{ ansible_password }}" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@192.168.253.160 "cat > /var/lib/tftpboot/grub2/grub.cfg-01-{{ server.mac | regex_replace(':','-') | lower }}" <<EOF
    {{ lookup('template', 'grub-centos7.j2') }}
    EOF
  delegate_to: localhost

# STEP 2: MANAGE ESXi VM (Using vim-cmd and vmx editing)
- name: Configure and Power On VM on ESXi host
  shell: |
    # 1. Find the VMID on the ESXi host
    VMID=$(sshpass -p '{{ exsi_password }}' ssh -o StrictHostKeyChecking=no root@{{ exsi_hostname }} "vim-cmd vmsvc/getallvms | grep '{{ server.hostname }}' | awk '{print \$1}'")
    
    if [ -z "$VMID" ]; then echo "VM Not Found on ESXi"; exit 1; fi

    # 2. Power Off the VM if it is running
    sshpass -p '{{ exsi_password }}' ssh -o StrictHostKeyChecking=no root@{{ exsi_hostname }} "vim-cmd vmsvc/power.off $VMID" || true

    # 3. Set EFI Firmware and PXE Boot order via .vmx modification
    # This finds the .vmx path and ensures firmware is efi and boot order is network
    VMX_PATH=$(sshpass -p '{{ exsi_password }}' ssh -o StrictHostKeyChecking=no root@{{ exsi_hostname }} "vim-cmd vmsvc/get.config $VMID | grep -i 'vmxPath' | awk -F'\"' '{print \$2}'")
    
    sshpass -p '{{ exsi_password }}' ssh -o StrictHostKeyChecking=no root@{{ exsi_hostname }} <<EOF
      sed -i '/firmware/d' $VMX_PATH
      echo 'firmware = "efi"' >> $VMX_PATH
      sed -i '/bios.bootOrder/d' $VMX_PATH
      echo 'bios.bootOrder = "ethernet,disk"' >> $VMX_PATH
    EOF

    # 4. Power On the VM
    sshpass -p '{{ exsi_password }}' ssh -o StrictHostKeyChecking=no root@{{ exsi_hostname }} "vim-cmd vmsvc/power.on $VMID"

    # 5. Wait for PXE to engage (20s) then swap boot order back to disk
    sleep 20
    sshpass -p '{{ exsi_password }}' ssh -o StrictHostKeyChecking=no root@{{ exsi_hostname }} <<EOF
      sed -i '/bios.bootOrder/d' $VMX_PATH
      echo 'bios.bootOrder = "disk,ethernet"' >> $VMX_PATH
    EOF
  delegate_to: localhost

# STEP 3: MONITOR COMPLETION
- name: Wait for VM to respond to SSH (Port 22)
  wait_for:
    host: "{{ server.ip }}"
    port: 22
    state: started
    delay: 60
    timeout: 1200
  delegate_to: localhost

- name: Clean and Update SSH Keys
  shell: |
    ssh-keygen -R {{ server.ip }} || true
    ssh-keyscan -H {{ server.ip }} >> /tmp/known_hosts
  delegate_to: localhost

- name: Verify Kernel Version
  shell: "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/tmp/known_hosts root@{{ server.ip }} 'uname -r'"
  register: kernel_version
  delegate_to: localhost

- name: Final Result
  debug:
    msg: "VM {{ server.hostname }} is ready with kernel {{ kernel_version.stdout }}"
