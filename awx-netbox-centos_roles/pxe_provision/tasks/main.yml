---
# Main logic: Using a standard SSH pipe to bypass SFTP/Permissions issues
- name: Force write GRUB dispatcher via SSH pipe
  shell: |
    echo "{{ lookup('template', 'grub-dispatcher.j2') }}" | \
    ssh -o StrictHostKeyChecking=no root@192.168.253.160 "cat > /var/lib/tftpboot/grub2/grub.cfg"
  delegate_to: localhost
  run_once: true

- name: Provision PXE servers
  include_tasks: per_server.yml
  loop: "{{ servers }}"
  loop_control:
    loop_var: server
