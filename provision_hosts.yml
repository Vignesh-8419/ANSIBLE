---
- name: Prepare and create hosts in Foreman using curl
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    netbox_url: "https://192.168.253.134"
    netbox_token: "668d10258cfa6ad36826afdf4c3141be6f960369"

    foreman_server_url: "https://rocky-08-01.vgs.com:3000"
    foreman_user: "admin"
    foreman_password: "zqs977dXzqfEvTML"

    host_root_pass: "Root@123"

    cluster_name: "vgs-centos-cluster"
    target_servers:
      - cent-07-03
      - cent-07-04

  tasks:

    - name: Get devices from NetBox cluster
      uri:
        url: "{{ netbox_url }}/api/dcim/devices/?cluster={{ cluster_name }}"
        method: GET
        headers:
          Authorization: "Token {{ netbox_token }}"
        return_content: yes
        validate_certs: no
      register: netbox_devices

    - name: Filter only selected servers
      set_fact:
        filtered_devices: >-
          {{ netbox_devices.json.results
             | selectattr('name', 'in', target_servers)
             | list }}

    - name: Get interfaces from NetBox
      uri:
        url: "{{ netbox_url }}/api/dcim/interfaces/"
        method: GET
        headers:
          Authorization: "Token {{ netbox_token }}"
        return_content: yes
        validate_certs: no
      register: netbox_interfaces

    - name: Get IP addresses from NetBox
      uri:
        url: "{{ netbox_url }}/api/ipam/ip-addresses/"
        method: GET
        headers:
          Authorization: "Token {{ netbox_token }}"
        return_content: yes
        validate_certs: no
      register: netbox_ips

    - name: Build host info list
      set_fact:
        host_info: "{{ host_info | default([]) + [ {
          'name': item.name,
          'ip': (
              netbox_ips.json.results
              | selectattr('assigned_object.device.name', 'equalto', item.name)
              | map(attribute='address')
              | map('regex_replace', '/.*$', '')
              | list | first | default('')
          ),
          'mac': (
              netbox_interfaces.json.results
              | selectattr('device.name', 'equalto', item.name)
              | map(attribute='mac_address')
              | list | first | default('')
          )
        } ] }}"
      loop: "{{ filtered_devices }}"

    - name: Display host data
      debug:
        var: host_info

    # âœ… Create host in Foreman using curl
    - name: Create host in Foreman via API
      shell: |
        curl -k -u "{{ foreman_user }}:{{ foreman_password }}" \
        -H "Content-Type: application/json" \
        -X POST "{{ foreman_server_url }}/api/hosts" \
        -d '{
          "host": {
            "name": "{{ item.name }}",
            "organization_name": "Default Organization",
            "location_name": "Default Location",
            "architecture_name": "x86_64",
            "domain_name": "vgs.com",
            "operatingsystem_name": "CentOS 7",
            "medium_name": "CentOSLinux",
            "ptable_name": "Kickstart default",
            "subnet_name": "vgs-subnet-centos",
            "root_pass": "{{ host_root_pass }}",
            "managed": true,
            "build": true,
            "interfaces_attributes": [{
              "type": "interface",
              "mac": "{{ item.mac }}",
              "ip": "{{ item.ip }}",
              "primary": true,
              "provision": true
            }]
          }
        }'
      loop: "{{ host_info }}"
      register: foreman_create_output

    - name: Show Foreman API response
      debug:
        var: foreman_create_output
