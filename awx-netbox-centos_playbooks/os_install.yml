---
- name: PXE Provision CentOS servers via NetBox
  hosts: all
  gather_facts: false

  tasks:
    - name: Fail if host is not tagged for PXE
      assert:
        that:
          - "'pxe_centostag' in tags"
        fail_msg: "Host {{ inventory_hostname }} is not tagged with pxe_centostag in NetBox"

    - name: Load and normalize NetBox config context
      set_fact:
        nb_ctx: "{{ config_context | first | combine({}) }}"

    - name: Debug NetBox context
      debug:
        var: nb_ctx

    - name: Validate PXE/VMware variables from NetBox
      assert:
        that:
          - nb_ctx.http_server is defined
          - nb_ctx.kickstart_url is defined
          - nb_ctx.pxe_folder is defined
          - nb_ctx.vcenter_hostname is defined
          - nb_ctx.vcenter_username is defined
        fail_msg: "Required PXE or VMware variables missing in NetBox config_context"

    - name: Build PXE server structure from NetBox
      set_fact:
        servers:
          - hostname: "{{ inventory_hostname }}"
            ip: "{{ ansible_host }}"
            mac: "{{ interfaces[0].mac_address | lower }}"

    - name: Run PXE provisioning role
      include_role:
        name: awx-netbox-centos_roles/pxe_provision
      vars:
        vcenter_password: "{{ vmware_password }}"
