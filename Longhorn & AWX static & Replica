cat <<EOF | kubectl apply -f -
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: awx-static-pool
  namespace: metallb-system
spec:
  addresses:
  - 192.168.253.221-192.168.253.224
  - 192.168.253.226-192.168.253.230
---
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: longhorn-ip-pool
  namespace: metallb-system
spec:
  addresses:
  - 192.168.253.220/32
---
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: awx-combined-adv
  namespace: metallb-system
spec:
  ipAddressPools: [awx-static-pool, longhorn-ip-pool]
EOF

# Annotate Longhorn frontend service to use dedicated IP pool
kubectl annotate svc longhorn-frontend -n longhorn-system metallb.universe.tf/address-pool=longhorn-ip-pool --overwrite

# Restart MetalLB controller to force IP reassignment
kubectl rollout restart deployment controller -n metallb-system

# Watch Longhorn service until it gets the external IP
kubectl get svc longhorn-frontend -n longhorn-system -w

==========================================================================================================================================================================================================
==========================================================================================================================================================================================================
==========================================================================================================================================================================================================
 vi awx-static-pool.yaml

apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: awx-static-pool
  namespace: metallb-system
spec:
  addresses:
  - 192.168.253.220-192.168.253.224
  - 192.168.253.227-192.168.253.230
  autoAssign: true
  avoidBuggyIPs: false

 kubectl apply -f awx-static-pool.yaml

 vi awx-fixed-ip.yaml

apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: awx-fixed-ip
  namespace: metallb-system
spec:
  addresses:
  - 192.168.253.226/32
  autoAssign: true
  avoidBuggyIPs: false
---
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: awx-fixed-adv
  namespace: metallb-system
spec:
  ipAddressPools:
  - awx-fixed-ip


 kubectl apply -f awx-fixed-ip.yaml

 kubectl annotate svc awx-prod-service -n awx metallb.universe.tf/address-pool=awx-fixed-ip --overwrite

 kubectl rollout restart deployment controller -n metallb-system

 kubectl get svc awx-prod-service -n awx -w


==========================================================================================================================================================================================================
==========================================================================================================================================================================================================
==========================================================================================================================================================================================================


kubectl patch settings.longhorn.io storage-network-for-rwx-volume-enabled \
  -n longhorn-system --type=merge \
  -p '{"value":"true"}'


kubectl patch settings.longhorn.io rwx-volume-fast-failover \
  -n longhorn-system --type=merge \
  -p '{"value":"true"}'


kubectl get settings.longhorn.io -n longhorn-system | grep rwx


kubectl apply -f - <<EOF
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: longhorn-rwx
provisioner: driver.longhorn.io
parameters:
  numberOfReplicas: "3"
  staleReplicaTimeout: "30"
  fsType: ext4
  accessMode: ReadWriteMany
reclaimPolicy: Delete
volumeBindingMode: Immediate
EOF


kubectl get sc

kubectl edit awx awx-prod -n awx

spec:
  projects_storage_class: longhorn-rwx

kubectl get pods -n awx -w


kubectl edit awx awx-prod -n awx


replicas: 2              # web pods
task_replicas: 1         # task pods (production safe)
projects_storage_class: longhorn-rwx
postgres_storage_class: longhorn
projects_storage_access_mode: ReadWriteMany
service_type: LoadBalancer
loadbalancer_ip: 192.168.253.225

kubectl edit awx awx-prod -n awx
