---
# ============================================================
#  PLAY 1: Collect Facts From Target Hosts
# ============================================================

- name: Collect facts from all servers
  hosts: "{{ target_hosts.split(',') | map('trim') | list }}"
  gather_facts: yes
  become: yes

  # These come from AWX/Tower Survey
  vars:
    cluster_name: "{{ cluster_name }}"
    cluster_type: "{{ cluster_type }}"
    site_name: "{{ site_name }}"

  tasks:
    - name: Build server_info from facts
      set_fact:
        server_info:
          name: "{{ ansible_hostname }}.vgs.com"
          ip: "{{ ansible_default_ipv4.address }}/{{ (ansible_default_ipv4.address ~ '/' ~ ansible_default_ipv4.netmask) | ipaddr('prefix') }}"
          mac: "{{ ansible_default_ipv4.macaddress }}"
          interface: "{{ ansible_default_ipv4.interface }}"
          cluster_name: "{{ cluster_name }}"
          cluster_type: "{{ cluster_type }}"
          site_name: "{{ site_name }}"
          serial: "{{ ansible_product_serial | regex_replace('[^a-zA-Z0-9]', '') | truncate(50, True, '') }}"

    - name: Debug IP format
      debug:
        msg: "IP for {{ inventory_hostname }} is {{ server_info.ip }}"

# ============================================================
#  PLAY 2: Push Servers Into NetBox
# ============================================================

- name: Push collected servers into NetBox
  hosts: rocky-08-02
  gather_facts: no

  vars:
    netbox_url: "https://192.168.253.134"
    netbox_token: "668d10258cfa6ad36826afdf4c3141be6f960369"
    device_type_id: 1
    role_id: 1

  tasks:
    - name: Aggregate servers_list from hostvars
      set_fact:
        servers_list: "{{ target_hosts.split(',') | map('trim') | map('extract', hostvars, 'server_info') | list }}"

    - name: Debug servers_list
      debug:
        var: servers_list

    - name: Loop through servers and include device creation tasks
      include_tasks: 1_modified_create_netbox_device.yml
      loop: "{{ servers_list }}"
      loop_control:
        loop_var: item
