---
- name: Step 1 - Smart Hardware Audit on ESXi
  hosts: 192.168.253.128
  gather_facts: no
  vars:
    ansible_user: "{{ nb_ctx.exsi_username }}"
    ansible_password: "{{ nb_ctx.exsi_password }}"
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
  tasks:
    - name: Run Hardware Injection Script on ESXi
      raw: |
        IDS=$(vim-cmd vmsvc/getallvms 2>/dev/null | awk 'NR>1 {print $1}' | grep -E '^[0-9]+$')
        for VMID in $IDS; do
            VMNAME=$(vim-cmd vmsvc/getallvms | awk -v id="$VMID" '$1==id {print $2}')
            [ "$VMNAME" == "dns-server-01" ] && continue
            VMX_PATH=$(find /vmfs/volumes/ -name "${VMNAME}.vmx" | head -n 1)
            [ -z "$VMX_PATH" ] && continue

            if ! grep -q "serial0.present = \"TRUE\"" "$VMX_PATH"; then
                echo "Fixing $VMNAME"
                WID=$(localcli vm process list | grep -A 1 "$VMNAME" | grep "World ID" | awk '{print $3}')
                [ ! -z "$WID" ] && localcli vm process kill --type=force --world-id=$WID && sleep 2
                sed -i '/serial0/d' "$VMX_PATH"
                VPORT=$((2000 + $VMID))
                cat <<EOL >> "$VMX_PATH"
serial0.present = "TRUE"
serial0.yieldOnPoll = "TRUE"
serial0.fileType = "network"
serial0.fileName = "telnet://:$VPORT"
serial0.network.endPoint = "server"
EOL
                vim-cmd vmsvc/reload $VMID
                sleep 1
                vim-cmd vmsvc/power.on $VMID
            fi
        done
      register: hw_output

- name: Step 2 - Guest OS Configuration
  hosts: all
  gather_facts: no
  vars:
    ansible_user: "{{ nb_ctx.vm_root_user }}"
    ansible_password: "{{ nb_ctx.vm_root_password }}"
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
  tasks:
    # We skip the ESXi IP so it doesn't try to run Linux commands on the hypervisor
    - name: Skip ESXi and Wait for VM SSH
      wait_for_connection:
        delay: 5
        timeout: 300
      when: inventory_hostname != '192.168.253.128'

    - name: Check if GRUB is already configured
      shell: grep "console=ttyS0" /etc/default/grub
      register: grub_check
      ignore_errors: yes
      changed_when: false
      when: inventory_hostname != '192.168.253.128'

    - name: Apply Verbose Boot and Reboot
      block:
        - name: Copy script to VM
          copy:
            src: ./enable-verbose-boot.sh
            dest: /tmp/enable-verbose-boot.sh
            mode: '0755'

        - name: Execute script
          shell: /tmp/enable-verbose-boot.sh

        - name: Reboot VM
          reboot:
            reboot_timeout: 300
      when: 
        - inventory_hostname != '192.168.253.128'
        - grub_check.rc != 0
