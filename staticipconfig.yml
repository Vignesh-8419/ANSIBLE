---
- name: ðŸ›  Static Network Configuration
  hosts: "{{ target_hosts }}"
  become: true
  gather_facts: false

  vars:
    GATEWAY: "192.168.253.2"

  tasks:
    # 1. Detect primary interface (non-loopback, first IPv4)
    - name: Detect primary interface
      command: ip -o -4 addr show
      register: iface_list
      changed_when: false

    - name: Extract primary interface
      set_fact:
        primary_iface: "{{ (iface_list.stdout_lines | map('regex_search', '^[0-9]+: ([^ ]+)') | select('string') | list)[0] }}"

    # 2. Add temporary default gateway if missing
    - name: Add temporary default gateway if missing
      command: ip route add default via {{ GATEWAY }} dev {{ primary_iface }}
      ignore_errors: true
      register: default_gw_result
      changed_when: default_gw_result.rc == 0

    # 3. Download staticipconfig.sh from GitHub
    - name: Download staticipconfig.sh
      get_url:
        url: "https://raw.githubusercontent.com/Vignesh-8419/ANSIBLE/main/staticipconfig.sh"
        dest: "/tmp/staticipconfig.sh"
        mode: '0755'

    # 4. Execute staticipconfig.sh and save output
    - name: Execute staticipconfig.sh and save output
      command: /tmp/staticipconfig.sh
      register: static_ip_result
      ignore_errors: false

    - name: Save script output to file
      copy:
        content: "{{ static_ip_result.stdout }}"
        dest: /tmp/staticipconfig.txt
