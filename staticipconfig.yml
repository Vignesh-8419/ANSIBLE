---
- name: ðŸ›  Static Network Configuration
  hosts: "{{ target_hosts }}"
  become: true
  gather_facts: false

  vars:
    GATEWAY: "192.168.253.2"

  tasks:
    # 1. Detect primary interface
    - name: Detect primary interface
      shell: "ip -o -4 addr show | awk '!/ lo / {print $2}' | head -n 1"
      register: primary_iface
      changed_when: false

    # 2. Ensure default gateway is configured (temporary)
    - name: Ensure default gateway is configured
      shell: |
        IFACE="{{ primary_iface.stdout }}"
        # Add default route only if it doesn't exist
        if ! ip route show default | grep -q "via $GATEWAY dev $IFACE"; then
            ip route add default via "$GATEWAY" dev "$IFACE"
            echo "default gateway added"
        else
            echo "default gateway already exists, skipping"
        fi
      args:
        warn: false
      register: default_gw_result
      changed_when: "'default gateway added' in default_gw_result.stdout"

    # 3. Download staticipconfig.sh from GitHub
    - name: Download staticipconfig.sh
      get_url:
        url: "https://raw.githubusercontent.com/Vignesh-8419/ANSIBLE/main/staticipconfig.sh"
        dest: "/tmp/staticipconfig.sh"
        mode: '0755'

    # 4. Execute staticipconfig.sh and save output
    - name: Execute staticipconfig.sh and save output
      shell: "/tmp/staticipconfig.sh > /tmp/staticipconfig.txt 2>&1"
