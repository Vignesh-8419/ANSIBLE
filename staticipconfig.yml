---
- name: ðŸ›  Static Network Configuration
  hosts: "{{ target_hosts }}"
  become: true

  tasks:

    - name: Ensure default gateway is configured (idempotent)
      shell: |
        GATEWAY="192.168.253.2"
        IFACE=$(ip -o -4 addr show | awk '!/ lo / {print $2}' | head -n 1)

        # Exit if default route already exists
        if ip route show | grep -q "^default"; then
          exit 0
        fi

        # Add the route now
        ip route add default via "$GATEWAY" dev "$IFACE"

        # Add dispatcher to persist after reboot
        cat << 'EOF' > /etc/NetworkManager/dispatcher.d/99-default-route
#!/bin/bash
if [ "$2" = "up" ]; then
    GATEWAY="192.168.253.2"
    IFACE=$(ip -o -4 addr show | awk '!/ lo / {print $2}' | head -n 1)
    ip route replace default via "$GATEWAY" dev "$IFACE"
fi
EOF

        chmod +x /etc/NetworkManager/dispatcher.d/99-default-route
      args:
        warn: false

    - name: Add DNS entries in resolv.conf
      copy:
        dest: /etc/resolv.conf
        content: |
          # Generated by Config
          search vgs.com
          nameserver 192.168.253.151
        owner: root
        group: root
        mode: 0644

    - name: Download staticipconfig.sh from GitHub
      get_url:
        url: "https://raw.githubusercontent.com/Vignesh-8419/ANSIBLE/main/staticipconfig.sh"
        dest: "/tmp/staticipconfig.sh"
        mode: '0755'

    - name: Execute staticipconfig.sh and store output
      shell: "/tmp/staticipconfig.sh > /tmp/staticipconfig.txt 2>&1"
